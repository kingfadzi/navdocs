# Main PPM Deployment Pipeline
# This pipeline validates baseline and functional BOMs and triggers deployments based on file changes.

stages:
  - validate
  - deploy

# Default configuration
default:
  image: almalinux:8
  before_script:
    # Install Python 3.11 and system dependencies
    - dnf install -y -q git bash openssh-clients sshpass
    - dnf module reset -y python36
    - dnf install -y -q python3.11 python3.11-pip python3.11-devel
    - pip3.11 install PyYAML boto3 --quiet
    - ln -sf /usr/bin/python3.11 /usr/bin/python3

# ============================================================
# STAGE 1: VALIDATE
# ============================================================

validate_baseline:
  stage: validate
  script:
    - echo "Validating baseline BOM..."
    - python3 tools/validate_bom.py --file boms/baseline.yaml --branch "$CI_COMMIT_BRANCH"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/baseline.yaml
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml

validate_functional:
  stage: validate
  script:
    - echo "Validating functional BOM..."
    - python3 tools/validate_bom.py --file boms/functional.yaml --branch "$CI_COMMIT_BRANCH"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/functional.yaml

# ============================================================
# STAGE 2: DEPLOY
# ============================================================

deploy_baseline:
  stage: deploy
  trigger:
    include:
      - local: templates/gitlab-ci-template.yml
    strategy: depend
  variables:
    DEPLOYMENT_TYPE: baseline
    BOM_FILE: boms/baseline.yaml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/baseline.yaml
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml

deploy_functional:
  stage: deploy
  needs:
    - job: deploy_baseline
      optional: true  # Only wait if baseline job exists
  trigger:
    include:
      - local: templates/gitlab-ci-template.yml
    strategy: depend
  variables:
    DEPLOYMENT_TYPE: functional
    BOM_FILE: boms/functional.yaml
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/functional.yaml
