# PPM Deployment Pipeline
# Lean CI/CD pipeline using existing deploy.py script

stages:
  - validate
  - review
  - deploy

# Default configuration
default:
  image: almalinux:8
  before_script:
    - dnf install -y -q git python3 python3-pip bash
    - pip3 install PyYAML --quiet

# Variables
variables:
  BOM_DIR: "boms"


# ============================================================
# STAGE 1: VALIDATE
# Validates BOM schema and required fields
# ============================================================

validate:bom:
  stage: validate
  script:
    - echo "Validating BOM files..."
    - echo "Branch:$CI_COMMIT_BRANCH"
    - python3 tools/validate_bom.py --changed-files --branch "$CI_COMMIT_BRANCH"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

# ============================================================
# STAGE 2: REVIEW (Prod Only)
# Manual gate to review BOM before deployment
# ============================================================

review:prod:
  stage: review
  script:
    - echo "============================================================"
    - echo "PRODUCTION DEPLOYMENT REVIEW"
    - echo "============================================================"
    - echo ""
    - echo "BOM pending deployment:"
    - |
      if git diff --name-only $CI_COMMIT_BEFORE_SHA...HEAD | grep -q "^boms/baseline.yaml$"; then
        echo "  - boms/baseline.yaml (baseline-repave)"
        cat boms/baseline.yaml
      elif git diff --name-only $CI_COMMIT_BEFORE_SHA...HEAD | grep -q "^boms/functional.yaml$"; then
        echo "  - boms/functional.yaml (functional-release)"
        cat boms/functional.yaml
      fi
    - echo ""
    - echo "Review the BOM file in this MR to verify:"
    - echo "  - Correct target server (prod)"
    - echo "  - Correct entities and reference codes"
    - echo "  - Proper rollback_artifact specified"
    - echo "  - Change request approved"
    - echo ""
    - echo "Click 'Approve' to proceed with deployment."
    - echo "============================================================"
  when: manual
  allow_failure: false
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

# ============================================================
# STAGE 3: DEPLOY
# Run deployment using deploy.py
# Handles: extract → import → archive automatically
# ============================================================

# Hidden template for all deployment jobs
.deploy_template:
  stage: deploy
  script:
    - echo "Deploying to ${DEPLOY_ENV} environment..."
    - echo "Current directory:" && pwd
    - echo "Mock scripts:" && ls -la mock/ || echo "mock/ not found"
    - |
      # Check if both BOMs changed (prevent accidental dual deployment)
      BASELINE_CHANGED=$(git diff --name-only $CI_COMMIT_BEFORE_SHA...HEAD | grep -c "^boms/baseline.yaml$" || true)
      FUNCTIONAL_CHANGED=$(git diff --name-only $CI_COMMIT_BEFORE_SHA...HEAD | grep -c "^boms/functional.yaml$" || true)

      if [ $BASELINE_CHANGED -gt 0 ] && [ $FUNCTIONAL_CHANGED -gt 0 ]; then
        echo "============================================================"
        echo "ERROR: Both baseline.yaml and functional.yaml changed"
        echo "============================================================"
        echo "Baseline and functional are different deployment types."
        echo "Create separate commits for each deployment type."
        echo "============================================================"
        exit 1
      fi

      # Determine which static BOM changed
      if [ $BASELINE_CHANGED -gt 0 ]; then
        BOM_FILE="boms/baseline.yaml"
        DEPLOY_TYPE="baseline-repave"
      elif [ $FUNCTIONAL_CHANGED -gt 0 ]; then
        BOM_FILE="boms/functional.yaml"
        DEPLOY_TYPE="functional-release"
      else
        echo "No baseline.yaml or functional.yaml changes detected"
        exit 0
      fi

      echo "BOM: $BOM_FILE"
      echo "Deployment type: $DEPLOY_TYPE"
      echo ""

      # Execute deployment (environment already validated by validate:bom job)
      python3 tools/deploy.py $DEPLOY_TYPE --bom "$BOM_FILE" 2>&1 | tee deployment.log

      # Capture exit code
      DEPLOY_EXIT_CODE=${PIPESTATUS[0]}

      echo ""
      echo "Deployment exit code: $DEPLOY_EXIT_CODE"

      exit $DEPLOY_EXIT_CODE
    - echo "${DEPLOY_ENV} deployment complete"
  artifacts:
    when: always
    paths:
      - deployment.log
      - boms/baseline.yaml
      - boms/functional.yaml
      - archives/*.zip
      - evidence/*.zip

deploy:test:
  extends: .deploy_template
  variables:
    DEPLOY_ENV: "TEST"
  artifacts:
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

deploy:staging:
  extends: .deploy_template
  variables:
    DEPLOY_ENV: "STAGING"
  artifacts:
    expire_in: 90 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

deploy:prod:
  extends: .deploy_template
  variables:
    DEPLOY_ENV: "PROD"
  artifacts:
    expire_in: 1 year
  dependencies:
    - review:prod
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

# ============================================================
# ROLLBACK JOBS
# Manual rollback triggered within deployment pipeline
# Uses rollback_artifact from the same BOM that was deployed
# ============================================================

# Hidden template for all rollback jobs
.rollback_template:
  stage: deploy
  script:
    - echo "Rolling back ${DEPLOY_ENV} environment..."
    - |
      # Detect which BOM changed (same logic as deployment)
      BASELINE_CHANGED=$(git diff --name-only $CI_COMMIT_BEFORE_SHA...HEAD | grep -c "^boms/baseline.yaml$" || true)
      FUNCTIONAL_CHANGED=$(git diff --name-only $CI_COMMIT_BEFORE_SHA...HEAD | grep -c "^boms/functional.yaml$" || true)

      if [ $BASELINE_CHANGED -gt 0 ] && [ $FUNCTIONAL_CHANGED -gt 0 ]; then
        echo "ERROR: Both BOMs changed - cannot determine which to rollback"
        exit 1
      fi

      # Determine which BOM to use for rollback
      if [ $BASELINE_CHANGED -gt 0 ]; then
        BOM_FILE="boms/baseline.yaml"
      elif [ $FUNCTIONAL_CHANGED -gt 0 ]; then
        BOM_FILE="boms/functional.yaml"
      else
        echo "No BOM changes detected"
        exit 0
      fi

      echo "Rollback BOM: $BOM_FILE"
      echo ""

      # Execute rollback using rollback_artifact from BOM
      python3 tools/deploy.py rollback --bom "$BOM_FILE" 2>&1 | tee rollback.log

      # Capture exit code
      ROLLBACK_EXIT_CODE=${PIPESTATUS[0]}

      echo ""
      echo "Rollback exit code: $ROLLBACK_EXIT_CODE"

      exit $ROLLBACK_EXIT_CODE
    - echo "${DEPLOY_ENV} rollback complete"
  when: manual
  allow_failure: false
  artifacts:
    when: always
    paths:
      - rollback.log
      - evidence/*.zip
    expire_in: 1 year

rollback:test:
  extends: .rollback_template
  variables:
    DEPLOY_ENV: "TEST"
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

rollback:staging:
  extends: .rollback_template
  variables:
    DEPLOY_ENV: "STAGING"
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

rollback:prod:
  extends: .rollback_template
  variables:
    DEPLOY_ENV: "PROD"
  dependencies:
    - review:prod
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
