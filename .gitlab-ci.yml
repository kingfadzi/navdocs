# PPM Deployment Pipeline - Dynamic Child Pipeline Architecture
# Generates child pipeline based on which BOMs changed and target environment

stages:
  - validate
  - generate
  - deploy

# Default configuration
default:
  image: almalinux:8
  before_script:
    # Install Python 3.11 on AlmaLinux 8
    - dnf install -y -q git bash
    - dnf module reset -y python36
    - dnf install -y -q python3.11 python3.11-pip python3.11-devel
    - pip3.11 install PyYAML --quiet
    - ln -sf /usr/bin/python3.11 /usr/bin/python3

# Variables
variables:
  BOM_DIR: "boms"

# ============================================================
# STAGE 1: VALIDATE
# Validates BOM schema and required fields
# ============================================================

validate:bom:
  stage: validate
  script:
    - echo "Validating BOM files..."
    - echo "Branch: $CI_COMMIT_BRANCH"
    - python3 tools/validate_bom.py --changed-files --branch "$CI_COMMIT_BRANCH"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

# ============================================================
# STAGE 2: GENERATE
# Dynamically generates child pipeline based on changes
# ============================================================

generate:pipeline:
  stage: generate
  script:
    - echo "Generating dynamic child pipeline..."
    - echo "Branch: $CI_COMMIT_BRANCH"
    - python3 tools/generate_pipeline.py
  artifacts:
    paths:
      - generated-pipeline.yml
    expire_in: 1 hour
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml

# ============================================================
# STAGE 3: DEPLOY
# Triggers the dynamically generated child pipeline
# ============================================================

trigger:deploy:
  stage: deploy
  trigger:
    include:
      - artifact: generated-pipeline.yml
        job: generate:pipeline
    strategy: depend  # Wait for child pipeline to complete
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH == "develop"'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      changes:
        - boms/baseline.yaml
        - boms/functional.yaml
