# Production Deployment Configuration
# This is the default configuration used in production CI/CD pipelines
# For local testing, create deployment-config.local.yaml to override these settings

# kMigrator real installation paths (remote execution on PPM servers)
kmigrator:
  extract_script: "/opt/ppm/bin/kMigratorExtract.sh"
  import_script: "/opt/ppm/bin/kMigratorImport.sh"

# Deployment settings
deployment:
  bundle_dir: "./bundles"
  archive_dir: "./archives"
  storage_backend: "s3"  # S3 storage (bundles go directly: PPM → S3 → PPM)

# Vault Component Provider Registry
# Defines pluggable vault secret retrieval components with different parameter mappings
vault_component_providers:
  # Standard vault-secret-fetcher component (default)
  standard:
    component_url: "eros.butterflycluster.com/staging/vault-secret-fetcher/vault-retrieve"
    component_version: "v1.0.4"
    parameter_mappings:
      anchor_name: "anchor_name"       # Our internal name → Component's parameter name
      role: "vault_role"               # Our internal name → Component's parameter name
      secret_paths: "vault_secret_paths"  # Our internal name → Component's parameter name

  # Example: CSM vault retriever (alternative provider)
  # Uncomment and configure if using CSM vault system
  # csm:
  #   component_url: "eros.butterflycluster.com/staging/csm-vault/csm-retrieve"
  #   component_version: "v2.0.0"
  #   parameter_mappings:
  #     anchor_name: "anchor_name"
  #     role: "csm_role"               # CSM uses 'csm_role' instead of 'vault_role'
  #     secret_paths: "csm_secret_urls"  # CSM uses 'csm_secret_urls' instead of 'vault_secret_paths'

  # Example: HashiCorp Vault direct component
  # hashicorp:
  #   component_url: "gitlab.com/components/vault/hashicorp-vault-fetch"
  #   component_version: "v3.1.0"
  #   parameter_mappings:
  #     anchor_name: "output_anchor"
  #     role: "vault_approle"
  #     secret_paths: "secret_path_list"

# Global default vault component provider (can be overridden per server or S3)
vault_component_provider: "standard"

s3:
  bucket_name: "ppm-deployment-bundles"
  region: "us-east-1"
  prefix: "bundles/"
  endpoint_url: "http://phobos:9002"
  vault_roles:
    - name: s3-read
      path: secret/data/shared/s3

# PPM Server Registry with SSH configuration for remote execution
# Credentials injected from GitLab CI/CD environment variables (via Vault):
#
# SSH credentials (vault: secret/data/infrastructure/ssh/{server}):
#   - SSH_USERNAME: OS-level user for SSH/SCP access to remote servers
#   - SSH_PASSWORD: Password for SSH authentication
#
# PPM credentials (vault: secret/data/ppm/{env}/useast):
#   - PPM_SERVICE_ACCOUNT_USER: PPM service account username for kMigrator/API operations
#   - PPM_SERVICE_ACCOUNT_PASSWORD: PPM service account password

servers:
  dev-ppm-useast:
    url: "https://ppm-dev.company.com"
    env_type: dev
    region: useast
    ssh_host: "mars"
    ssh_env_vars:
      username: "SSH_USERNAME"
      password: "SSH_PASSWORD"
    ppm_api_env_vars:
      username: "PPM_SERVICE_ACCOUNT_USER"
      password: "PPM_SERVICE_ACCOUNT_PASSWORD"
    vault_roles:
      - name: ssh-infra
        path: secret/data/infrastructure/ssh/mars
      - name: ppm-dev
        path: secret/data/ppm/dev/useast

  test-ppm-useast:
    url: "https://ppm-test.company.com"
    env_type: test
    region: useast
    ssh_host: "phobos"
    ssh_env_vars:
      username: "SSH_USERNAME"
      password: "SSH_PASSWORD"
    ppm_api_env_vars:
      username: "PPM_SERVICE_ACCOUNT_USER"
      password: "PPM_SERVICE_ACCOUNT_PASSWORD"
    vault_roles:
      - name: ssh-infra
        path: secret/data/infrastructure/ssh/phobos
      - name: ppm-test
        path: secret/data/ppm/test/useast

  staging-ppm-useast:
    url: "https://ppm-staging.company.com"
    env_type: staging
    region: useast
    ssh_host: "cygnus"
    ssh_env_vars:
      username: "SSH_USERNAME"
      password: "SSH_PASSWORD"
    ppm_api_env_vars:
      username: "PPM_SERVICE_ACCOUNT_USER"
      password: "PPM_SERVICE_ACCOUNT_PASSWORD"
    vault_roles:
      - name: ssh-infra
        path: secret/data/infrastructure/ssh/cygnus
      - name: ppm-staging
        path: secret/data/ppm/staging/useast

  prod-ppm-useast:
    url: "https://ppm-prod.company.com"
    env_type: prod
    region: useast
    ssh_host: "helios"
    ssh_env_vars:
      username: "SSH_USERNAME"
      password: "SSH_PASSWORD"
    ppm_api_env_vars:
      username: "PPM_SERVICE_ACCOUNT_USER"
      password: "PPM_SERVICE_ACCOUNT_PASSWORD"
    vault_roles:
      - name: ssh-infra
        path: secret/data/infrastructure/ssh/helios
      - name: ppm-prod
        path: secret/data/ppm/prod/useast
